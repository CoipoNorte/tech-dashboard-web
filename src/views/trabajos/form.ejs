<%- include('../partials/header', { title }) %>
<h1><%= title %></h1>
<form action="<%= action %>" method="post" id="trabajoForm">

  <!-- Cliente -->
  <div class="mb-3" style="max-width: 350px;">
    <label>Cliente</label>
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-person"></i></span>
      <select name="cliente" class="form-control" required>
        <option value="">Seleccione...</option>
        <% clientes.forEach(c => { %>
          <option value="<%= c._id %>" <%= (trabajo.cliente && trabajo.cliente.toString() === c._id.toString()) || (clienteId && clienteId == c._id) ? 'selected' : '' %>><%= c.nombre %></option>
        <% }) %>
      </select>
    </div>
  </div>

  <!-- Descripción -->
  <div class="mb-3">
    <label>Descripción</label>
    <div class="input-group">
      <span class="input-group-text bg-primary text-white"><i class="bi bi-card-text"></i></span>
      <textarea name="descripcion" class="form-control border-primary" rows="3" maxlength="500" placeholder="Describe el trabajo realizado..." required oninput="document.getElementById('descCount').textContent = this.value.length + '/500';"><%= trabajo.descripcion || '' %></textarea>
    </div>
    <div class="text-end small text-muted"><span id="descCount"><%= (trabajo.descripcion || '').length %></span>/500</div>
  </div>

  <!-- Observaciones -->
  <div class="mb-3">
    <label>Observaciones</label>
    <div class="input-group">
      <span class="input-group-text bg-info text-white"><i class="bi bi-chat-left-text"></i></span>
      <textarea name="observaciones" class="form-control border-info" rows="2" maxlength="300" placeholder="Observaciones adicionales..." oninput="document.getElementById('obsCount').textContent = this.value.length + '/300';"><%= trabajo.observaciones || '' %></textarea>
    </div>
    <div class="text-end small text-muted"><span id="obsCount"><%= (trabajo.observaciones || '').length %></span>/300</div>
  </div>

  <!-- Precio, Fecha Ingreso, Fecha Entrega -->
  <div class="row mb-3">
    <div class="col-md-4 mb-2 mb-md-0">
      <label>Precio</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-cash-coin"></i></span>
        <input type="number" name="precio" class="form-control" value="<%= trabajo.precio || '' %>">
      </div>
    </div>
    <div class="col-md-4 mb-2 mb-md-0">
      <label>Fecha Ingreso</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-calendar-plus"></i></span>
        <input type="date" name="fechaIngreso" id="fechaIngreso" class="form-control" value="<%= trabajo.fechaIngresoInput || '' %>">
      </div>
    </div>
    <div class="col-md-4">
      <label>Fecha Entrega</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
        <input type="date" name="fechaEntrega" id="fechaEntrega" class="form-control" value="<%= trabajo.fechaEntregaInput || '' %>">
      </div>
    </div>
  </div>

  <!-- Categoría, Estado, Urgencia -->
  <div class="row mb-3">
    <div class="col-md-4 mb-2 mb-md-0">
      <label>Categoría</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-tags"></i></span>
        <select name="categoria" class="form-select" id="selectCategoria" required>
          <option value="">Seleccione...</option>
          <% categorias.forEach(cat => { %>
            <option value="<%= cat._id %>" <%= (trabajo.categoria && trabajo.categoria.toString() === cat._id.toString()) ? 'selected' : '' %>>
              <%= cat.nombre %>
            </option>
          <% }) %>
        </select>
      </div>
    </div>
    <div class="col-md-4 mb-2 mb-md-0">
      <label>Estado</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-flag"></i></span>
        <select name="estado" class="form-select" id="selectEstado" required>
          <option value="">Seleccione...</option>
          <% estados.forEach(est => { %>
            <option value="<%= est._id %>" <%= (trabajo.estado && trabajo.estado.toString() === est._id.toString()) ? 'selected' : '' %>>
              <%= est.nombre %>
            </option>
          <% }) %>
        </select>
      </div>
    </div>
    <div class="col-md-4">
      <label>Urgencia</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-exclamation-circle-fill"></i></span>
        <select name="urgencia" id="selectUrgencia" class="form-select" required>
          <option value="">Seleccione...</option>
          <% urgencias.forEach(urg => { %>
            <option value="<%= urg._id %>"
              <%= (trabajo.urgencia && ((trabajo.urgencia._id ? trabajo.urgencia._id.toString() : trabajo.urgencia.toString()) === urg._id.toString())) ? 'selected' : '' %>>
              <%= urg.nombre.toLowerCase() %>
            </option>
          <% }) %>
        </select>
        <button type="button" class="btn btn-outline-info" id="calcularUrgenciaBtn" title="Calcular urgencia automáticamente">
          <i class="bi bi-lightning-charge"></i>
        </button>
      </div>
      <div id="urgenciaMsg" class="alert alert-success mt-2 d-none py-2 px-3" role="alert"></div>
    </div>
  </div>

  <div class="text-center">
    <button class="btn btn-primary"><i class="bi bi-save"></i> Guardar</button>
    <a href="/trabajos" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('calcularUrgenciaBtn');
  const urgenciaSelect = document.getElementById('selectUrgencia');
  const fechaEntregaInput = document.getElementById('fechaEntrega');
  const urgenciaMsg = document.getElementById('urgenciaMsg');
  if (btn && urgenciaSelect && fechaEntregaInput) {
    btn.addEventListener('click', function() {
      const fechaEntrega = fechaEntregaInput.value;
      let urgencia = 'nula';
      if (fechaEntrega) {
        const hoy = new Date();
        hoy.setHours(0,0,0,0);
        const d2 = new Date(fechaEntrega);
        d2.setHours(0,0,0,0);
        const diff = (d2 - hoy) / (1000 * 60 * 60 * 24);
        if (diff >= 14) urgencia = 'baja';
        else if (diff >= 7) urgencia = 'media';
        else if (diff >= 0) urgencia = 'alta';
      }
      let found = false;
      for (let i = 0; i < urgenciaSelect.options.length; i++) {
        const texto = urgenciaSelect.options[i].textContent.trim().toLowerCase();
        if (texto === urgencia) {
          urgenciaSelect.selectedIndex = i;
          found = true;
          break;
        }
      }
      if (urgenciaMsg) {
        urgenciaMsg.classList.remove('d-none', 'alert-danger', 'alert-success');
        if (found) {
          urgenciaMsg.classList.add('alert-success');
          urgenciaMsg.textContent = 'Urgencia seleccionada: ' + urgencia.charAt(0).toUpperCase() + urgencia.slice(1);
        } else {
          urgenciaMsg.classList.add('alert-danger');
          urgenciaMsg.textContent = 'No se encontró la opción de urgencia "' + urgencia + '". Verifica los nombres en la base de datos.';
        }
      }
    });
  }
});
</script>
<%- include('../partials/footer') %>