<%- include('../partials/header', { title }) %>
<h1><%= title %></h1>
<form action="<%= action %>" method="post" enctype="multipart/form-data" id="trabajoForm">
  <div class="mb-3">
    <label>Cliente</label>
    <select name="cliente" class="form-control" required>
      <option value="">Seleccione...</option>
      <% clientes.forEach(c => { %>
        <option value="<%= c._id %>" <%= (trabajo.cliente && trabajo.cliente.toString() === c._id.toString()) || (clienteId && clienteId == c._id) ? 'selected' : '' %>><%= c.nombre %></option>
      <% }) %>
    </select>
  </div>
  <div class="mb-3">
    <label>Descripción</label>
    <input type="text" name="descripcion" class="form-control" value="<%= trabajo.descripcion || '' %>" required>
  </div>
  <div class="mb-3">
    <label>Observaciones</label>
    <textarea name="observaciones" class="form-control"><%= trabajo.observaciones || '' %></textarea>
  </div>
  <div class="mb-3">
    <label>Precio</label>
    <input type="number" name="precio" class="form-control" value="<%= trabajo.precio || '' %>">
  </div>
  <div class="mb-3">
    <label>Fecha Ingreso</label>
    <input type="date" name="fechaIngreso" id="fechaIngreso" class="form-control" value="<%= trabajo.fechaIngresoInput || '' %>">
  </div>
  <div class="mb-3">
    <label>Fecha Entrega</label>
    <input type="date" name="fechaEntrega" id="fechaEntrega" class="form-control" value="<%= trabajo.fechaEntregaInput || '' %>">
  </div>
  <div class="mb-3">
    <label>Categoría</label>
    <select name="categoria" class="form-control" required>
      <option value="">Seleccione...</option>
      <% categorias.forEach(cat => { %>
        <option value="<%= cat._id %>" <%= (trabajo.categoria && trabajo.categoria.toString() === cat._id.toString()) ? 'selected' : '' %>><%= cat.nombre %></option>
      <% }) %>
    </select>
  </div>
  <div class="mb-3">
    <label>Estado</label>
    <select name="estado" class="form-control" required>
      <option value="">Seleccione...</option>
      <% estados.forEach(est => { %>
        <option value="<%= est._id %>" <%= (trabajo.estado && trabajo.estado.toString() === est._id.toString()) ? 'selected' : '' %>><%= est.nombre %></option>
      <% }) %>
    </select>
  </div>
  <div class="mb-3">
    <label>Urgencia</label>
    <div class="input-group">
      <select name="urgencia" id="urgenciaSelect" class="form-control" required>
        <option value="">Seleccione...</option>
        <% urgencias.forEach(urg => { %>
          <option value="<%= urg._id %>" data-nombre="<%= urg.nombre %>"
            <%= (trabajo.urgencia && ((trabajo.urgencia._id ? trabajo.urgencia._id.toString() : trabajo.urgencia.toString()) === urg._id.toString())) ? 'selected' : '' %>>
            <%= urg.nombre %>
          </option>
        <% }) %>
      </select>
      <button type="button" class="btn btn-outline-info" id="calcularUrgenciaBtn" title="Calcular urgencia automáticamente">
        <i class="bi bi-lightning-charge"></i> Calcular
      </button>
    </div>
  </div>
  <div class="mb-3">
    <label>Imagen</label>
    <% if (trabajo.imagen) { %>
      <img src="/uploads/<%= trabajo.imagen %>" style="width:100px;"><br>
    <% } %>
    <input type="file" name="imagen" class="form-control">
  </div>
  <button class="btn btn-primary">Guardar</button>
  <a href="/trabajos" class="btn btn-secondary">Cancelar</a>
</form>

<script>
document.getElementById('calcularUrgenciaBtn').addEventListener('click', function() {
  const fechaIngreso = document.getElementById('fechaIngreso').value;
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const urgenciaSelect = document.getElementById('urgenciaSelect');
  if (!fechaIngreso || !fechaEntrega) {
    for (let i = 0; i < urgenciaSelect.options.length; i++) {
      if (urgenciaSelect.options[i].text.toLowerCase().trim() === 'nula') {
        urgenciaSelect.selectedIndex = i;
        break;
      }
    }
    return;
  }
  const d1 = new Date(fechaIngreso);
  const d2 = new Date(fechaEntrega);
  const diff = (d2 - d1) / (1000 * 60 * 60 * 24);
  let urgencia = 'nula';
  if (diff >= 7) urgencia = 'baja';
  else if (diff >= 3) urgencia = 'media';
  else if (diff >= 0) urgencia = 'alta';
  for (let i = 0; i < urgenciaSelect.options.length; i++) {
    if (urgenciaSelect.options[i].getAttribute('data-nombre') && urgenciaSelect.options[i].getAttribute('data-nombre').toLowerCase().trim() === urgencia) {
      urgenciaSelect.selectedIndex = i;
      break;
    }
  }
});
</script>
<%- include('../partials/footer') %>