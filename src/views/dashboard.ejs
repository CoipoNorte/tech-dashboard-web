<%- include('partials/header', { title }) %>
<%
function getTextColor(bgColor) {
  if (!bgColor) return "#000";
  var r = parseInt(bgColor.substr(1,2),16);
  var g = parseInt(bgColor.substr(3,2),16);
  var b = parseInt(bgColor.substr(5,2),16);
  var yiq = ((r*299)+(g*587)+(b*114))/1000;
  return (yiq >= 128) ? "#000" : "#fff";
}
%>

<div class="row align-items-center mb-4">
  <div class="col">
    <h1 class="display-5 fw-bold mb-0"><i class="bi bi-speedometer2"></i> Dashboard</h1>
  </div>
  <div class="col-auto">
    <% if (!tokenExists) { %>
      <a href="/auth/google" class="btn btn-outline-success btn-lg">
        <i class="bi bi-google"></i> Conectar Google Drive
      </a>
    <% } else { %>
      <button type="button" class="btn btn-outline-danger btn-lg" id="disconnectBtn">
        <i class="bi bi-google"></i> Desconectar Google Drive
      </button>
    <% } %>
  </div>
</div>
<hr>

<div class="row g-4">
  <div class="col-md-4">
    <a href="/clientes" style="text-decoration:none;">
      <div class="card shadow-sm border-0 text-bg-primary mb-3">
        <div class="card-body d-flex flex-column align-items-center">
          <i class="bi bi-people-fill" style="font-size:2.5rem;"></i>
          <h5 class="card-title mt-2">Clientes</h5>
          <p class="card-text fs-2 fw-bold"><%= totalClientes %></p>
        </div>
      </div>
    </a>
  </div>
  <% if (typeof categorias !== 'undefined') { categorias.forEach(cat => { %>
    <div class="col-md-4">
      <a href="/trabajos?categoria=<%= cat._id %>" style="text-decoration:none;">
        <div class="card shadow-sm border-0 mb-3" style="background-color: #f8f9fa;">
          <div class="card-body d-flex flex-column align-items-center" style="color: #222;">
            <i class="<%= cat.icono || 'bi bi-tag' %>" style="font-size:2.5rem"></i>
            <h5 class="card-title mt-2"><%= cat.nombre %></h5>
          </div>
        </div>
      </a>
    </div>
  <% }) } %>
  <% estados.forEach(estado => { %>
    <div class="col-md-4">
      <a href="/trabajos?estado=<%= estado._id %>" style="text-decoration:none;">
        <div class="card shadow-sm border-0 mb-3" style="background-color: <%= estado.color %>;">
          <div class="card-body d-flex flex-column align-items-center" style="color: <%= getTextColor(estado.color) %>;">
            <i class="<%= estado.icono || 'bi bi-flag' %>" style="font-size:2.5rem"></i>
            <h5 class="card-title mt-2"><%= estado.nombre %></h5>
            <p class="card-text fs-2 fw-bold"><%= trabajosPorEstado[estado.nombre] || 0 %></p>
          </div>
        </div>
      </a>
    </div>
  <% }) %>
</div>

<%- include('partials/alerts') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('disconnectBtn');
  if (btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoader('Desconectando Google Drive...');
      fetch('/disconnect-drive')
        .then(() => {
          setTimeout(() => {
            hideLoader();
            window.location.href = '/dashboard';
          }, 1200);
        });
    });
  }
});
</script>
<%- include('partials/footer') %>